{% extends "base.html" %}
{% block title %}Admin Dashboard | Kirwara VTC{% endblock %}

{% block content %}
<div class="container">
  <h1>Admin Dashboard</h1>

  <!-- ================= ADMIN ACTIONS ================= -->
  <div style="margin-bottom:20px;">
    <a href="{{ url_for('create_instructor') }}" class="btn btn-primary">
      âž• Add Instructor
    </a>
    <a href="{{ url_for('admin_exams') }}" class="btn btn-primary">
      ðŸ“Š Examination Performance
    </a>
    <a href="{{ url_for('logout') }}" class="btn btn-secondary" style="float:right;">
      Logout
    </a>
  </div>

  <!-- ================= STUDENTS TABLE ================= -->
  <h2>Student Registrations</h2>
  <input type="text" id="studentSearch" placeholder="Search students..." class="search-box">

  <table id="studentsTable">
    <thead>
      <tr>
        <th>#</th><th>Name</th><th>DOB</th><th>Gender</th><th>Email</th>
        <th>Phone</th><th>Course</th><th>Constituency</th>
        <th>Admission No</th><th>Payment</th><th>Amount</th><th>Notes</th><th>Action</th>
      </tr>
    </thead>
    <tbody>
      {% for idx, student in students %}
      <tr>
        <td>{{ idx+1 }}</td>
        <td>{{ student[0] }}</td>
        <td>{{ student[1] }}</td>
        <td>{{ student[2] }}</td>
        <td>{{ student[3] }}</td>
        <td>{{ student[4] }}</td>
        <td>{{ student[5] }}</td>
        <td>{{ student[6] }}</td>
        <td>{{ student[7] }}</td>
        <td class="{% if student[8]=='Pending' %}pending{% endif %}">{{ student[8] }}</td>
        <td>{{ student[9] }}</td>
        <td>{{ student[10] }}</td>
        <td>
          <button class="btn btn-primary" onclick="openEdit({{ idx }})">Edit</button>
          <form action="{{ url_for('delete_student', index=idx) }}" method="POST" style="display:inline;">
            <button class="btn btn-danger" onclick="return confirm('Delete this student?')">Delete</button>
          </form>
        </td>
      </tr>
      {% endfor %}
    </tbody>
  </table>

  <!-- ================= EDIT STUDENT FORMS (HIDDEN) ================= -->
  {% for idx, student in students %}
  <div class="edit-card" id="editStudent{{ idx }}">
    <h3>Edit Student: {{ student[0] }}</h3>

    <form method="POST" action="{{ url_for('edit', index=idx) }}" enctype="multipart/form-data">
      <label>Full Name</label>
      <input type="text" name="fullname" value="{{ student[0] }}" required>

      <label>Date of Birth</label>
      <input type="date" name="dob" value="{{ student[1] }}">

      <label>Gender</label>
      <select name="gender">
        <option {% if student[2]=='Male' %}selected{% endif %}>Male</option>
        <option {% if student[2]=='Female' %}selected{% endif %}>Female</option>
      </select>

      <label>Email</label>
      <input type="email" name="email" value="{{ student[3] }}">

      <label>Phone</label>
      <input type="text" name="phone" value="{{ student[4] }}">

      <label>Course</label>
      <input type="text" name="course" value="{{ student[5] }}">

      <label>Constituency</label>
      <input type="text" name="constituency" value="{{ student[6] }}">

      <label>Admission No</label>
      <input type="text" name="admission_no" value="{{ student[7] }}">

      <label>Payment Status</label>
      <select name="payment_status">
        <option {% if student[8]=='Pending' %}selected{% endif %}>Pending</option>
        <option {% if student[8]=='Partial' %}selected{% endif %}>Partial</option>
        <option {% if student[8]=='Paid' %}selected{% endif %}>Paid</option>
      </select>

      <label>Amount Paid</label>
      <input type="number" name="amount_paid" value="{{ student[9] }}">

      <label>Notes</label>
      <textarea name="notes">{{ student[10] }}</textarea>

      <label>Password</label>
      <input type="text" name="password" value="{{ student[11] }}">

      <label>Passport</label>
      <input type="file" name="passport">
      {% if student[12] %}
        <small>
          Current: <a href="{{ url_for('static', filename='uploads/' ~ student[12]) }}" target="_blank">View</a>
        </small>
      {% endif %}

      <br><br>
      <button class="btn btn-primary">Save Changes</button>
      <button type="button" class="btn btn-secondary" onclick="closeEdit({{ idx }})">Cancel</button>
    </form>
  </div>
  {% endfor %}

  <!-- ================= CONTACT MESSAGES ================= -->
  <h2>Contact Messages</h2>
  <input type="text" id="contactSearch" placeholder="Search messages..." class="search-box">

  <table id="contactsTable">
    <thead>
      <tr>
        <th>#</th><th>Date</th><th>Name</th><th>Email</th><th>Phone</th><th>Message</th><th>File</th><th>Action</th>
      </tr>
    </thead>
    <tbody>
      {% for idx, msg in contacts %}
      <tr>
        <td>{{ idx+1 }}</td>
        <td>{{ msg[0] }}</td>
        <td>{{ msg[1] }}</td>
        <td>{{ msg[2] }}</td>
        <td>{{ msg[3] }}</td>
        <td>{{ msg[4] }}</td>
        <td>
          {% if msg[5] %}
            <a href="{{ url_for('static', filename='uploads/' ~ msg[5]) }}" target="_blank">View</a>
          {% else %}-{% endif %}
        </td>
        <td>
          <form action="{{ url_for('delete_contact', index=idx) }}" method="POST">
            <button class="btn btn-danger" onclick="return confirm('Delete message?')">Delete</button>
          </form>
        </td>
      </tr>
      {% endfor %}
    </tbody>
  </table>

  <!-- ================= INSTRUCTORS ================= -->
  <h2>Instructors</h2>
  <table class="table">
    <thead>
      <tr>
        <th>#</th><th>Full Name</th><th>Username</th><th>Course</th><th>Photo</th><th>Edit</th><th>Delete</th>
      </tr>
    </thead>
    <tbody>
      {% for idx, instructor in instructors %}
      <tr>
        <td>{{ idx+1 }}</td>
        <td>{{ instructor[0] }}</td>
        <td>{{ instructor[1] }}</td>
        <td>{{ instructor[3] }}</td>
        <td>
          {% if instructor|length > 4 and instructor[4] %}
            <img src="{{ url_for('static', filename='uploads/instructors/' ~ instructor[4]) }}"
                 style="width:60px; height:60px; border-radius:50%;">
          {% else %}
            No Photo
          {% endif %}
        </td>
        <td>
          <a href="{{ url_for('edit_instructor', index=idx) }}" class="btn btn-primary">Edit</a>
        </td>
        <td>
          <form method="POST" action="{{ url_for('delete_instructor', index=idx) }}" onsubmit="return confirm('Are you sure?');">
            <button type="submit" class="btn btn-danger">Delete</button>
          </form>
        </td>
      </tr>
      {% endfor %}
    </tbody>
  </table>
</div>

<!-- ================= JS ================= -->
<script>
function filterTable(inputId, tableId) {
  document.getElementById(inputId).addEventListener("keyup", function() {
    const value = this.value.toLowerCase();
    document.querySelectorAll(`#${tableId} tbody tr`).forEach(row => {
      row.style.display = row.textContent.toLowerCase().includes(value) ? "" : "none";
    });
  });
}

filterTable("studentSearch","studentsTable");
filterTable("contactSearch","contactsTable");

function openEdit(index) {
  document.querySelectorAll(".edit-card").forEach(card => card.style.display="none");
  const card = document.getElementById("editStudent"+index);
  card.style.display="block";
  card.scrollIntoView({behavior:"smooth"});
}

function closeEdit(index) {
  document.getElementById("editStudent"+index).style.display="none";
}
</script>

<style>
.container { max-width:1200px; margin:auto; padding:20px; }
.search-box { width:100%; padding:10px; margin:10px 0 20px; }
table { width:100%; border-collapse:collapse; margin-bottom:30px; }
th,td { border:1px solid #ddd; padding:8px; }
th { background:#0b7dda; color:white; }
tr:nth-child(even) { background:#f9f9f9; }
.pending { color:red; font-weight:bold; }

.btn { padding:6px 12px; border:none; color:white; cursor:pointer; border-radius:4px; }
.btn-primary { background:#0b7dda; }
.btn-secondary { background:#777; }
.btn-danger { background:#e74c3c; }

.edit-card {
  display:none;
  background:#fff;
  padding:15px;
  margin-bottom:30px;
  box-shadow:0 2px 10px rgba(0,0,0,0.15);
}

input, select, textarea {
  width:100%;
  padding:8px;
  margin-bottom:10px;
}
</style>

{% endblock %}